{%- if current_tags != blank -%}
    {%- assign all_tags_downcase = collection.tags | json | downcase -%}
    {%- assign current_arr = '' -%}
    {%- assign new_current_arr = '' -%}
    {%- for tag in current_tags -%}
        {% assign newtag = tag | handleize | prepend: '_' %}
        {%- assign current_arr = current_arr | append: tag | append:',' | downcase -%}
        {%- assign new_current_arr = new_current_arr | append: newtag | append:',' | downcase -%}
    {%- endfor -%}
    {%- assign new_current_tags = new_current_arr | split:',' -%}
    {%- assign current_tags = current_arr | split:',' -%}

{%- else -%}
  {% for tag in collection.all_tags %}
    {% assign new_tag = tag | handleize | json | downcase %}
    {%- assign all_tags_downcase = all_tags_downcase | append: new_tag -%}
  {% endfor %}
{%- endif -%}

<script src="{{ 'tags-filters.min.js' | asset_url }}" defer="defer"></script>
<collection-tags-filters>
{% for block in section.blocks %}
  {% case block.type %}
    {% when 'collections' %}
      {% render 'widget-collections-list', block: block %}
    {% else %}
      {% render 'widget-tags-filter',
        block: block,
        new_current_tags: new_current_tags,
        all_tags_downcase: all_tags_downcase,
        current_tags: current_tags
      %}
  {% endcase %}
{% endfor %}
</collection-tags-filters>
